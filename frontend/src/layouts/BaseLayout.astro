---
/**
 * BaseLayout - Layout principal del sitio
 * Incluye ThemeProvider, Header, Footer y estilos globales
 * Con detección automática de tenant por dominio
 */

import ThemeProvider from '@/components/theme/ThemeProvider.astro';
import Header from '@/components/layout/Header.astro';
import Footer from '@/components/layout/Footer.astro';
import MobileMenu from '@/components/layout/MobileMenu.astro';
import SearchModal from '@/components/search/SearchModal.astro';
import CartDrawer from '@/components/cart/CartDrawer.astro';
import ToastContainer from '@/components/toast/ToastContainer.astro';
import { getTenantByDomain } from '@/utils/tenant/tenantResolver';
import { tenantToContext, getTenantDisplayName } from '@/types';
import type { TenantContext } from '@/types';
import '@/styles/global.css';

interface Props {
  title?: string;
  description?: string;
  showHeader?: boolean;
  showFooter?: boolean;
}

const {
  title = 'Quality Ecommerce - Tienda Online en Colombia',
  description = 'Encuentra los mejores productos al mejor precio. Envíos a toda Colombia.',
  showHeader = true,
  showFooter = true
} = Astro.props;

// ============================================
// DETECCIÓN DE TENANT
// ============================================
// El tenant es detectado por el middleware (src/middleware.ts)
const { tenant: tenantContext } = Astro.locals;

// Si no se encuentra tenant (y el middleware no redirigió por alguna razón), mostrar error 404
if (!tenantContext) {
  console.error(`❌ No se encontró tenant en locals`);
  return Astro.redirect('/404');
}

console.log(`✅ Tenant activo: ${tenantContext.nombre} (ID: ${tenantContext.id})`);

// ============================================
// CONFIGURACIÓN DEL SITIO
// ============================================
const siteName = getTenantDisplayName(tenantContext);
const fullTitle = title.includes(siteName) ? title : `${title} | ${siteName}`;

// Hacer tenant disponible globalmente para otros componentes
// Se pasa como prop a los componentes que lo necesiten
---

<!DOCTYPE html>
<html lang="es-CO">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Theme Provider (carga fuentes y CSS variables del tenant) -->
    <ThemeProvider tenant={tenantContext} />

    <!-- Title -->
    <title>{fullTitle}</title>

    <!-- Slot para meta tags adicionales desde páginas -->
    <slot name="head" />

    <!-- Pasar tenant al cliente via script global (sin tokens privados) -->
    <script is:inline define:vars={{ tenant: tenantContext }}>
      window.__TENANT__ = tenant;
    </script>
  </head>

  <body class="min-h-screen flex flex-col bg-background text-text">
    <!-- Header (con tenant para logo y branding) -->
    {showHeader && <Header tenant={tenantContext} />}

    <!-- Main Content -->
    <main class="flex-grow">
      <slot />
    </main>

    <!-- Footer (con tenant para textos legales) -->
    {showFooter && <Footer tenant={tenantContext} />}

    <!-- Mobile Menu Drawer (global) -->
    <MobileMenu />

    <!-- Search Modal (global) -->
    <SearchModal />

    <!-- Cart Drawer (global) -->
    <CartDrawer />

    <!-- Toast Container (global) -->
    <ToastContainer />

    <!-- Botón Volver Arriba -->
    <button
      id="scroll-to-top"
      class="fixed bottom-6 right-6 w-14 h-14 bg-black/80 backdrop-blur-sm text-white rounded-full shadow-2xl hover:bg-black hover:scale-110 active:scale-95 transition-all duration-300 opacity-0 pointer-events-none z-40 flex items-center justify-center border-2 border-white/20 hover:border-white/40"
      aria-label="Volver arriba"
    >
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/>
      </svg>
    </button>

    <!-- Slot para scripts adicionales -->
    <slot name="scripts" />

    <!-- Script para botón scroll to top -->
    <script>
      const scrollBtn = document.getElementById('scroll-to-top');

      // Mostrar/ocultar botón según scroll
      window.addEventListener('scroll', () => {
        if (scrollBtn) {
          if (window.scrollY > 300) {
            scrollBtn.classList.remove('opacity-0', 'pointer-events-none');
            scrollBtn.classList.add('opacity-100');
          } else {
            scrollBtn.classList.add('opacity-0', 'pointer-events-none');
            scrollBtn.classList.remove('opacity-100');
          }
        }
      });

      // Scroll suave al top
      scrollBtn?.addEventListener('click', () => {
        window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
      });
    </script>
  </body>
</html>
